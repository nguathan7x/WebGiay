@* @model IEnumerable<WebGiayOnline.Models.Giay> *@
@using System.Globalization
@model List<WebGiayOnline.ViewModels.GiayWithDiscountViewModel>

@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@inject IHttpContextAccessor HttpContextAccessor




@{
    ViewData["Title"] = "Home Page";
    
    var isAjax = Context.Request.Headers["X-Requested-With"] == "XMLHttpRequest";
    Layout = isAjax ? null : "~/Views/Shared/_Layout.cshtml";

}

<!DOCTYPE html>
<html lang="en">
<head>
</head>
<body>
 @*    <h1 class="display-4">@Localizer["WelcomeMessage"]</h1> *@
    @Localizer[""]
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-4">
        <a class="navbar-brand" href="#"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a6/Logo_NIKE.svg" height="30" alt="Nike Logo"></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="#">New & Featured</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Men</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Women</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Kids</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Sale</a></li>
            </ul>

            <form class="d-flex position-relative" role="search" asp-action="Index" asp-controller="Home" method="get">
                <input id="searchInput" class="form-control me-2" type="search" name="searchTerm"
                       value="@ViewBag.SearchTerm" placeholder="@Localizer["Search..."]" autocomplete="off" />

                <!-- Kết quả gợi ý -->
                <div id="suggestions" class="list-group position-absolute w-100" style="top: 100%; z-index: 1050;"></div>

                <input type="hidden" name="gender" value="@ViewBag.CurrentGender" />
                <input type="hidden" name="brandId" value="@ViewBag.CurrentBrandId" />

                <button type="button" onclick="startVoiceSearch()" class="btn btn-outline-secondary me-2">🎤</button>
                <button class="btn btn-outline-dark" type="submit">@Localizer["Search"]</button>
            </form>
        </div>
    </nav>

    <!-- Main content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <aside class="col-md-2 mb-4">
                <h5>Jordan Shoes (@ViewBag.TotalShoes)</h5>           
                <div class="accordion" id="sidebarAccordion">
                    <div class="accordion-item">
                        <h6 class="accordion-header" id="genderHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#genderCollapse">
                                @Localizer["Gender"]                             
                            </button>
                        </h6>
                        <div id="genderCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-unstyled ps-3">
                                    @foreach (var gender in ViewBag.AvailableGenders as List<string>)
                                    {
                                        <li>
                                            <a asp-controller="Home" asp-action="Index" asp-route-gender="@gender"
                                               class="@(ViewBag.CurrentGender == gender.ToLower() ? "fw-bold text-primary" : "")">
                                                @gender
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h6 class="accordion-header" id="sizeHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sizeCollapse">
                                @Localizer["Size"]
                            </button>
                        </h6>
                        <div id="sizeCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-unstyled ps-3">
                                    @foreach (var size in ViewBag.AvailableSizes as List<string>)
                                    {
                                        <li>
                                            <a asp-controller="Home" asp-action="Index"
                                               asp-route-size="@size"
                                               class="@(ViewBag.CurrentSize == size ? "fw-bold text-primary" : "")">
                                                @size
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h6 class="accordion-header" id="priceHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#priceCollapse">
                                @Localizer["Price"]
                            </button>
                        </h6>
                        <div id="priceCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body p-0 ps-3">
                                <ul class="list-unstyled">
                                    <li><a asp-controller="Home" asp-action="Index" asp-route-priceRange="0-1000000">@Localizer["Under ₫1M"]</a></li>
                                    <li><a asp-controller="Home" asp-action="Index" asp-route-priceRange="1000000-2000000">@Localizer["₫1M – ₫2M"]</a></li>
                                    <li><a asp-controller="Home" asp-action="Index" asp-route-priceRange="2000000-3000000">@Localizer["₫2M – ₫3M"]</a></li>
                                    <li><a asp-controller="Home" asp-action="Index" asp-route-priceRange="3000000-9000000">@Localizer["₫3M+"]</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>


                    <div class="accordion-item">
                        <h6 class="accordion-header" id="saleHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#saleCollapse">
                                @Localizer["Sale & Offer"]
                            </button>
                        </h6>
                        <div id="saleCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-unstyled ps-3">
                                    <li>
                                        <a asp-controller="Home" asp-action="Index"
                                           asp-route-hasDiscount="true"
                                       
                                           class="@(ViewBag.HasDiscount == true ? "fw-bold text-danger" : "")">
                                            @Localizer["Current Discount"]
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h6 class="accordion-header" id="brandHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#brandCollapse">
                                @Localizer["Brand"]
                            </button>
                        </h6>
                        <div id="brandCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-unstyled ps-3">
                                    @foreach (var brand in ViewBag.Brands as List<WebGiayOnline.Models.Brand>)
                                    {
                                        <li><a asp-controller="Home" asp-action="Index" asp-route-brandId="@brand.BrandId">@brand.Name</a></li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Product Grid -->
            <main class="col-md-10">
                <div class="row g-4">
                             
                    @foreach (var item in Model)
                    {
                        var discount = item.ActiveDiscount;
                        var price = item.Giay.Price;
                        <div class="col-md-4 col-sm-6">
                            <div class="card h-100 shadow-sm">
                                <img src="@item.Giay.ImageUrl" class="card-img-top" alt="@item.Giay.Name" style="height: 300px; object-fit: cover;">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">@item.Giay.Name</h5>
                                    @if (discount != null)
                                    {
                                        var discountedPrice = price * (1 - (decimal)discount.Percentage / 100);

                                        <p>
                                            <span style="text-decoration:line-through;">>@price.ToString("C0", CultureInfo.GetCultureInfo("vi-VN")) </span>
                                            <strong style="color:red;">@discountedPrice.ToString("C0", CultureInfo.GetCultureInfo("vi-VN")) </strong>
                                            <br />
                                            <small>@Localizer["Off"]: @discount.Percentage%</small>
                                        </p>
                                    }
                                    else
                                    {
                                        <p><strong>@price.ToString("C0", CultureInfo.GetCultureInfo("vi-VN"))</strong></p>
                                    }                              
                                    <p class="card-text text-muted" style="font-size: 0.9rem;">
                                        @(string.IsNullOrEmpty(item.Giay.Gender) ? "Shoes" : $"{item.Giay.Gender}'s Shoes")
                                    </p>
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="me-2">
                                            <span class="text-warning" style="font-size: 1.1rem;">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <text>
                                                        @if (i <= Math.Floor(item.AvgRating))
                                                        {
                                                            <i class="fas fa-star"></i>
                                                        }
                                                        else if (i - item.AvgRating < 1)
                                                        {
                                                            <i class="fas fa-star-half-alt"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="far fa-star"></i>
                                                        }
                                                    </text>
                                                }
                                            </span>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.9rem;">
                                            @item.AvgRating.ToString("0.0") / 5
                                            <span class="ms-1">(@item.TotalReviews @Localizer["reviews"])</span>
                                        </div>
                                    </div>

                                    <a href="@Url.Action("Details", "Product", new { id = item.Giay.GiayId })" class="btn btn-dark mt-auto ajax-link">@Localizer["Detail"]</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </main>
        </div>
    </div>

</body>
</html>
@using System.Globalization
@section Scripts {
    <script>
        function startVoiceSearch() {
            const searchInput = document.getElementById("searchInput");

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("Trình duyệt của bạn không hỗ trợ tìm kiếm bằng giọng nói.");
                return;
            }

            const recognition = new SpeechRecognition();

            // Razor gắn ngôn ngữ từ server
            const currentLang = "@CultureInfo.CurrentUICulture.TwoLetterISOLanguageName";

            if (currentLang === "vi") {
                recognition.lang = "vi-VN";
            } else if (currentLang === "en") {
                recognition.lang = "en-US";
            } else {
                recognition.lang = "en-US"; // fallback
            }

            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.start();

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                searchInput.value = transcript;
            };

            recognition.onerror = function(event) {
                console.error("Lỗi khi nhận dạng giọng nói:", event.error);
                alert("Không nhận dạng được giọng nói.");
            };
        }
    </script>

    <script>
        const $searchInput = $("#searchInput");
        const $suggestions = $("#suggestions");

        $searchInput.on("input", function() {
            const query = $(this).val();

            if (query.length >= 2) {
                $.ajax({
                    url: '/Home/SearchSuggestions',
                    data: { term: query },
                    success: function(data) {
                        $suggestions.empty();
                        if (data.length > 0) {
                            data.forEach(name => {
                                $suggestions.append(`<a href="#" class="list-group-item list-group-item-action">${name}</a>`);
                            });

                            $(".list-group-item").on("click", function(e) {
                                e.preventDefault();
                                $searchInput.val($(this).text());
                                $searchInput.closest("form").submit();
                            });
                        }
                    }
                });
            } else {
                $suggestions.empty();
            }
        });

        // Ẩn gợi ý khi click ra ngoài
        $(document).on("click", function(e) {
            if (!$(e.target).closest("#searchInput").length) {
                $suggestions.empty();
            }
        });
    </script>
}

}

